{"version":3,"file":"public/javascripts/app.js","sources":["app/initialize.coffee","app/javascripts/MapControl.coffee","app/javascripts/SearchBox.coffee","app/javascripts/application.coffee"],"names":[],"mappings":"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","sourcesContent":["Application = require 'application'\napp = new Application","module.exports = class MapControl\n\tconstructor: ->\n    @markerDict = {}\n    @map = L.map('map',\n        scrollWheelZoom: false\n      )\n      .setView([59.9218, 10.73427], 10)\n      # .addLayer(L.mapbox.tileLayer('examples.map-20v6611k',\n      .addLayer(L.mapbox.tileLayer('evenwestvang.hp8gagn1',\n        detectRetina: true\n    ))\n\n\n    svg = d3.select(@map.getPanes().overlayPane).append(\"svg\")\n    g = svg.append(\"g\").attr(\"class\", \"leaflet-zoom-hide\")\n\n    d3.json \"data/primaries.json\", (collection)=> \n      smallIcon = L.icon(\n          iconUrl: 'images/small_icon.png',\n          iconRetinaUrl: 'images/small_icon@2x.png',\n          iconSize:     [20, 20], \n          iconAnchor:   [10, 10], \n          popupAnchor:  [0, -1] \n      )\n\n      popupTemplate = require \"templates/popup\"\n\n      onEachFeature = (feature, layer)=>\n        properties = feature.properties\n        if properties\n          layer.bindPopup(popupTemplate(properties: properties))\n\n      pointToLayer = (feature, latlng)=>\n        marker = L.marker(latlng, {icon: smallIcon})\n        @markerDict[feature.properties.NAVN] = marker\n\n      L.geoJson(collection,\n        pointToLayer: pointToLayer\n        onEachFeature: onEachFeature\n        ).addTo(@map)\n\n    d3.json \"data/school_boundaries.topo.json\", (collection)=> \n    \n      projectStream = (x,y,that)=>\n        point = @map.latLngToLayerPoint(new L.LatLng(y, x))\n        that.stream.point(point.x, point.y)\n\n      reset = ()=>\n        bounds = path.bounds(topo)\n        topLeft = bounds[0]\n        bottomRight = bounds[1]\n\n        svg.attr(\"width\", bottomRight[0] - topLeft[0])\n          .attr(\"height\", bottomRight[1] - topLeft[1])\n          .style(\"left\", topLeft[0] + \"px\")\n          .style(\"top\", topLeft[1] + \"px\")\n\n        g.attr(\"transform\", \"translate(\" + -topLeft[0] + \",\" + -topLeft[1] + \")\")\n\n        feature.attr(\"d\", path)\n\n      topo = topojson.mesh(collection, collection.objects.school_boundaries);\n      transform = d3.geo.transform({point: (x,y)->projectStream(x,y,this)})\n      path = d3.geo.path().projection(transform)\n\n      feature = g.append(\"path\")\n        .datum(topo)\n\n      @map.on(\"viewreset\", reset)\n\n      reset()\n\n  focusOnSchoolName: (name)->\n    window.location = \"#map\"\n    console.info @markerDict[name]\n    marker = @markerDict[name]\n    marker.openPopup()\n    @map.setView(marker._latlng, 13)","\nmodule.exports = class SearchBox\n\tconstructor: (controller) ->\n    @controller = controller\n    @streetTemplate = require \"templates/street_listing\"\n\n    d3.csv \"data/addresses.csv\", (@addresses)=> \n\n      @addressDict = {}\n      @addresses.forEach (address)=>\n\n        address.oddStart = +address.oddStart\n        address.evenStart = +address.evenStart\n        address.oddEnd = +address.oddEnd\n        address.evenEnd = +address.evenEnd\n\n        address.street = @capitaliseFirstLetter(address.street)\n        address.school = @capitaliseFirstLetter(address.school)\n\n        if (address.oddStart == 1 || address.oddStart == 0) && (address.evenStart == 2 || address.evenStart == 0) && (address.oddEnd == 9999 || address.oddEnd == 0) && (address.evenEnd == 9998 || address.evenEnd == 0)\n          address.entireStreet =  true\n        else\n          address.entireStreet = false\n\n        address.oddEnd = \"slutten\" if address.oddEnd == 9999\n        address.evenEnd = \"slutten\" if address.evenEnd == 9998\n\n        @addressDict[address.street] = [] if !@addressDict[address.street]?\n        @addressDict[address.street].push(address)\n\n      $(\"input#streetName\").keyup(@updateView)\n\n  capitaliseFirstLetter: (string) ->\n    string = string.toLowerCase()\n    string.charAt(0).toUpperCase() + string.slice(1);\n\n  updateView: (event) =>\n    fieldValue = $(\"input#streetName\").val()\n    streets = @search(fieldValue)\n\n    html = \"<ul>\"\n    streets.forEach (stretches)=>\n\n      # TODO: Double filtering is an artefact of awkward data structure. Refactor.\n      odd = stretches.sort (a,b)-> a.oddStart > b.oddStart\n      odd = odd.filter (a)-> ! (a.oddStart == 0)\n\n      even = stretches.sort (a,b)-> a.evenStart > b.evenStart\n      even = even.filter (a)-> ! (a.evenStart == 0)\n\n      html += @streetTemplate(street: stretches[0], even: even, odd: odd)\n\n    html = html + \"</ul>\"\n    $(\".searchResults\").html(html)\n    $(\".searchResults .schoolName\").click (e)=>\n      @controller.focusOnSchoolName(e.currentTarget.innerText)\n\n\tsearch: (matchString)=>\n    # TODO: Add sorting on levenshtein distance\n\n    matchString = matchString.replace(/\\s/g, '')\n    matches = []\n\n    if matchString == \"\"\n      return matches\n\n    expression = \"\"\n    len = matchString.length - 1\n    expression += matchString.charAt(i) + \"+.?\" for i in [0..len]\n    re = new RegExp(expression, \"i\")\n\n    Object.keys(@addressDict).every (street)=>\n      matches.push(@addressDict[street]) if re.test(street)\n      return false if matches.length > 10\n      return true\n\n    return matches \n\n","\nMapControl = require 'MapControl'\nSearchBox = require 'SearchBox'\n\nmodule.exports = class Application\n\tconstructor: ->\n    @searchBox = new SearchBox(this)\n    @mapControl = new MapControl()\n\n  focusOnSchoolName: (name)->\n    @mapControl.focusOnSchoolName(name)\n"]}