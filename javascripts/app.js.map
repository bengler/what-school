{"version":3,"file":"public/javascripts/app.js","sources":["app/initialize.coffee","app/javascripts/SearchBox.coffee","app/javascripts/application.coffee"],"names":[],"mappings":"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","sourcesContent":["Application = require 'application'\napp = new Application","\nmodule.exports = class SearchBox\n\tconstructor: (controller) ->\n    @controller = controller\n    @streetTemplate = require \"templates/street_listing\"\n    @lastFieldValue = $(\"input#streetName\").val()\n\n    @loadingPromise = new Promise (resolve, reject) =>\n\n      d3.csv \"data/addresses.csv.json\", (@addresses) => \n        @addressDict = {}\n        @addresses.forEach (address)=>\n\n          address.oddStart = +address.oddStart\n          address.evenStart = +address.evenStart\n          address.oddEnd = +address.oddEnd\n          address.evenEnd = +address.evenEnd\n\n          address.street = @capitaliseFirstLetter(address.street)\n          address.school = @capitaliseFirstLetter(address.school)\n\n          oneSchool = false\n          oneSchool = true if (address.oddStart == 1) && (address.evenStart == 2) && (address.oddEnd == 9999) && (address.evenEnd == 9998)\n\n          if !@addressDict[address.street]?\n            street = {\n              streetName: address.street\n              oneSchool: oneSchool\n            }\n\n            if oneSchool\n              street.school = address.school\n            else\n              street.oddNumbers = []\n              street.evenNumbers = []\n\n            @addressDict[address.street] = street\n\n          # Todo: Perhaps DRY this up\n          if !oneSchool\n            if address.oddStart != 0 && address.oddEnd != 0\n              @addressDict[address.street].oddNumbers.push {\n                school: address.school\n                range: [address.oddStart, address.oddEnd]\n              }\n\n            if address.evenStart != 0 && address.evenEnd != 0\n              @addressDict[address.street].evenNumbers.push {\n                school: address.school\n                range: [address.evenStart, address.evenEnd]\n              }\n\n        sortOnFirstValue = (array) ->\n          return undefined unless array\n          array.sort (a,b)-> a.range[0] > b.range[0]\n\n        Object.keys(@addressDict).forEach (key) =>\n          street = @addressDict[key]\n          sortOnFirstValue(street.oddNumbers)\n          sortOnFirstValue(street.evenNumbers)\n\n        resolve(1)\n        $(\"input#streetName\").keydown(_.debounce( (() => @keyEvent()) , 500))\n        $(\"input#streetName\").keyup(_.debounce( (() => @keyEvent()) , 500))\n        $(\"input#streetName\").change(_.debounce( (() => @keyEvent()) , 500))\n\n  setQuery: (string) ->\n    $(\"input#streetName\").val(string)\n    @loadingPromise.then ()=>\n      @updateView()\n\n  capitaliseFirstLetter: (string) ->\n    string = string.toLowerCase()\n    string.charAt(0).toUpperCase() + string.slice(1);\n\n  keyEvent: (e) =>\n    @currentFieldValue = $(\"input#streetName\").val()\n    if @lastFieldValue != @currentFieldValue\n      history.replaceState({}, \"\", \"?streetName=\" + encodeURI(@currentFieldValue))\n      @lastFieldValue = $(\"input#streetName\").val()\n      @updateView()\n\n  updateView: () =>\n    fieldValue = $(\"input#streetName\").val()\n    result = @processInput(fieldValue)\n    if result\n      streets = result.matches\n\n      html = \"<ul>\"\n      streets.forEach (street)=>\n        html += @streetTemplate(street: street, digit: result.digit)\n      html = html + \"</ul>\"\n\n      $(\".searchResults\").html(html)\n\n      isNavigation = (e)->\n        if e.type == \"click\" || e.keyCode == 13 || e.keyCode == 32\n          ref = e.target\n          ref ||= e.srcElement\n          if ref\n            e.preventDefault()\n            return true\n        return false\n\n      navigateMap = (e)=>\n        if isNavigation(e)\n          console.info $(e.currentTarget)\n          console.info this\n          @controller.focusOnSchoolName(e.currentTarget.innerText)\n\n      navigateStreet = (e)=>\n        if isNavigation(e)\n          $(\"input#streetName\").val(e.currentTarget.innerText + \" \")\n          $(\"input#streetName\").focus()\n\n      $(\".searchResults .missingDigit .streetName\").keydown(navigateStreet)\n      $(\".searchResults .missingDigit .streetName\").click(navigateStreet)\n      $(\".searchResults .schoolName\").keydown(navigateMap)\n      $(\".searchResults .schoolName\").click(navigateMap)\n      $(\".searchResults, .inputWrapper\").addClass(\"populated\")\n    else\n      $(\".searchResults\").html(\"\")\n      $(\".searchResults, .inputWrapper\").removeClass(\"populated\")\n\n\tprocessInput: (matchString)=>\n    # TODO: Add sorting on levenshtein distance\n    digitMatch = matchString.match(/\\d+/g)\n\n    if digitMatch\n      digit = digitMatch[0] \n      matchString = matchString.slice(0,matchString.search(/\\d/))\n\n    digit ||= 0\n\n    matchString = matchString.replace(/\\s/g, '')\n\n    if matchString == \"\"\n      return false\n\n    expression = \"^\"\n    len = matchString.length - 1\n    expression += matchString.charAt(i) + \"+.?\" for i in [0..len]\n    re = new RegExp(expression, \"i\")\n\n    matches = []\n\n    Object.keys(@addressDict).every (street)=>\n      matches.push(@addressDict[street]) if re.test(street)\n      return false if matches.length > 10\n      return true\n\n    matches.forEach (street)=>\n      unless street.oneSchool && digit?\n        if digit % 2 == 0\n          side = \"evenNumbers\"\n        else\n          side = \"oddNumbers\"\n\n        matchedSchool = 0\n        street[side].forEach (schoolRange)->\n          if digit >= schoolRange.range[0] && digit <= schoolRange.range[1]\n            matchedSchool = schoolRange.school \n          street.school = matchedSchool\n\n    return {\n      digit: digit\n      matches: matches \n    }\n\n","\nMapControl = require 'MapControl'\nSearchBox = require 'SearchBox'\n\nmodule.exports = class Application\n\tconstructor: ->\n    @searchBox = new SearchBox(this)\n    @mapControl = new MapControl()\n\n    $(document).ready ()=>\n      query = location.search.split(\"=\")\n      if query[0] == \"?streetName\" && query[1]?\n        @searchBox.setQuery(decodeURI(query[1]))\n\n  focusOnSchoolName: (name)->\n    @mapControl.focusOnSchoolName(name)\n\n"]}